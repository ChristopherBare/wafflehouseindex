name: Auto Deploy on Master Push

on:
  # Automatic deployment when pushing to master
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/workflows/*.yml'
      - '!.github/workflows/auto-deploy-master.yml'

env:
  # Default version configuration for automatic builds
  # These can be overridden by version tags (e.g., v1.2.3)
  DEFAULT_VERSION: '1.0.0'
  DEFAULT_BUILD_NUMBER: ${{ github.run_number }}

jobs:
  # First, get CloudFront URL if backend already deployed
  get-backend-url:
    name: Get Backend URL
    runs-on: ubuntu-latest
    outputs:
      cloudfront_url: ${{ steps.get-url.outputs.cloudfront_url }}
      backend_exists: ${{ steps.get-url.outputs.backend_exists }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Check Existing Backend
        id: get-url
        run: |
          cd terraform

          # Check if state bucket exists
          if aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null; then
            echo "State bucket exists, checking for existing infrastructure..."

            # Initialize Terraform
            terraform init -input=false 2>/dev/null || true

            # Try to get CloudFront URL from existing state
            if terraform state list 2>/dev/null | grep -q "aws_cloudfront_distribution.whi_api"; then
              CLOUDFRONT_URL=$(terraform output -raw cloudfront_url 2>/dev/null || echo "")
              if [ ! -z "$CLOUDFRONT_URL" ]; then
                echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
                echo "backend_exists=true" >> $GITHUB_OUTPUT
                echo "âœ… Found existing backend: $CLOUDFRONT_URL"
              else
                echo "backend_exists=false" >> $GITHUB_OUTPUT
                echo "âš ï¸ Backend exists but CloudFront URL not found"
              fi
            else
              echo "backend_exists=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No existing backend infrastructure found"
            fi
          else
            echo "backend_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Terraform state bucket found"
          fi

  # Deploy or update backend if code changed
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: get-backend-url
    if: |
      contains(github.event.head_commit.modified, 'terraform/') ||
      contains(github.event.head_commit.modified, 'lambda/') ||
      needs.get-backend-url.outputs.backend_exists != 'true'
    outputs:
      cloudfront_url: ${{ steps.get-url.outputs.cloudfront_url }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Package Lambda Function
        run: |
          cd lambda
          chmod +x package.sh
          ./package.sh

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy Infrastructure
        run: |
          cd terraform

          # Ensure backend exists
          aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null || {
            echo "Creating state bucket..."
            aws s3api create-bucket --bucket whi-terraform-state --region us-east-1
            aws s3api put-bucket-versioning --bucket whi-terraform-state --versioning-configuration Status=Enabled
            aws s3api put-bucket-encryption \
              --bucket whi-terraform-state \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }]
              }'
          }

          aws dynamodb describe-table --table-name whi-terraform-lock 2>/dev/null || {
            echo "Creating lock table..."
            aws dynamodb create-table \
              --table-name whi-terraform-lock \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region us-east-1
            aws dynamodb wait table-exists --table-name whi-terraform-lock --region us-east-1
          }

          # Deploy
          terraform init -input=false
          terraform apply -auto-approve -input=false

      - name: Get CloudFront URL
        id: get-url
        run: |
          cd terraform
          CLOUDFRONT_URL=$(terraform output -raw cloudfront_url)
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed: $CLOUDFRONT_URL"

      - name: Test Deployment
        run: |
          CLOUDFRONT_URL="${{ steps.get-url.outputs.cloudfront_url }}"
          echo "Testing API..."
          curl -f "$CLOUDFRONT_URL/api/health" || exit 1
          echo "âœ… API is healthy"

  # Build apps if Flutter code changed
  build-apps:
    name: Build Apps
    needs: [get-backend-url, deploy-backend]
    if: |
      always() &&
      (contains(github.event.head_commit.modified, 'whi_flutter/') || github.event.forced)
    strategy:
      matrix:
        platform: [android, ios]
        include:
          - platform: android
            os: ubuntu-latest
          - platform: ios
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract Version from Tag or Use Default
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            echo "version_name=$VERSION" >> $GITHUB_OUTPUT
            echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          else
            echo "version_name=${{ env.DEFAULT_VERSION }}" >> $GITHUB_OUTPUT
            echo "build_number=${{ env.DEFAULT_BUILD_NUMBER }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Update API Configuration
        run: |
          cd whi_flutter

          # Get CloudFront URL from either the existing backend or newly deployed
          CLOUDFRONT_URL="${{ needs.deploy-backend.outputs.cloudfront_url }}"
          if [ -z "$CLOUDFRONT_URL" ]; then
            CLOUDFRONT_URL="${{ needs.get-backend-url.outputs.cloudfront_url }}"
          fi

          if [ ! -z "$CLOUDFRONT_URL" ]; then
            echo "Using CloudFront URL: $CLOUDFRONT_URL"

            cat > lib/config.dart << EOF
          /// API Configuration for Waffle House Index
          /// Auto-configured by GitHub Actions
          class ApiConfig {
            static const bool useProduction = true;
            static const String cloudfrontUrl = "$CLOUDFRONT_URL";
            static const String localUrlAndroid = "http://10.0.2.2:8000";
            static const String localUrlDesktop = "http://localhost:8000";
            static const String localUrlIOS = "http://localhost:8000";

            static String getApiBaseUrl({required bool isAndroid, required bool isIOS, required bool isDesktop}) {
              if (useProduction) {
                return cloudfrontUrl;
              }
              if (isAndroid) {
                return localUrlAndroid;
              } else if (isIOS) {
                return localUrlIOS;
              } else {
                return localUrlDesktop;
              }
            }
          }
          EOF
          else
            echo "âš ï¸ No CloudFront URL found, using local configuration"
          fi

      - name: Get Flutter Dependencies
        run: |
          cd whi_flutter
          flutter pub get

      - name: Update Version
        run: |
          cd whi_flutter
          VERSION="${{ steps.version.outputs.version_name }}"
          BUILD="${{ steps.version.outputs.build_number }}"

          if [ "${{ matrix.platform }}" == "android" ]; then
            sed -i "s/^version:.*/version: $VERSION+$BUILD/" pubspec.yaml
          else
            sed -i '' "s/^version:.*/version: $VERSION+$BUILD/" pubspec.yaml
          fi

          echo "Set version to $VERSION+$BUILD"

      # Android Build
      - name: Setup Android Signing
        if: matrix.platform == 'android'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
        run: |
          cd whi_flutter/android
          if [ ! -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/upload-keystore.jks
            echo "$ANDROID_KEY_PROPERTIES" > key.properties
            echo "âœ… Android signing configured"
          else
            echo "âš ï¸ No Android signing keys found, using debug signing"
          fi

      - name: Build Android App Bundle
        if: matrix.platform == 'android'
        run: |
          cd whi_flutter
          flutter build appbundle --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.build_number }}

          echo "âœ… Android AAB built successfully"

      # iOS Build
      - name: Setup iOS Signing
        if: matrix.platform == 'ios'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          if [ ! -z "$BUILD_CERTIFICATE_BASE64" ]; then
            CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
            PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
            KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

            echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
            echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

            security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH

            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

            echo "âœ… iOS signing configured"
          else
            echo "âš ï¸ No iOS signing keys found, building without signing"
          fi

      - name: Build iOS App
        if: matrix.platform == 'ios'
        run: |
          cd whi_flutter
          flutter build ios --release --no-codesign \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.build_number }}

          echo "âœ… iOS app built successfully"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build-auto-${{ github.run_number }}
          path: |
            whi_flutter/build/app/outputs/bundle/release/app-release.aab
            whi_flutter/build/ios/iphoneos/
          retention-days: 30

  # Final summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [get-backend-url, deploy-backend, build-apps]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          {
            echo "# ðŸš€ Automatic Deployment - Master Branch"
            echo ""
            echo "## Commit: ${{ github.sha }}"
            echo "**Message:** ${{ github.event.head_commit.message }}"
            echo "**Author:** ${{ github.event.head_commit.author.name }}"
            echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""

            # Backend status
            if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
              echo "### âœ… Backend Infrastructure"
              echo "- Deployed/Updated successfully"
              echo "- CloudFront: ${{ needs.deploy-backend.outputs.cloudfront_url }}"
            elif [ "${{ needs.deploy-backend.result }}" == "skipped" ]; then
              if [ "${{ needs.get-backend-url.outputs.backend_exists }}" == "true" ]; then
                echo "### âœ… Backend Infrastructure"
                echo "- Using existing deployment"
                echo "- CloudFront: ${{ needs.get-backend-url.outputs.cloudfront_url }}"
              else
                echo "### â­ï¸ Backend Infrastructure"
                echo "- No changes detected, skipped"
              fi
            else
              echo "### âŒ Backend Infrastructure"
              echo "- Deployment failed"
            fi

            echo ""

            # Apps status
            if [ "${{ needs.build-apps.result }}" == "success" ]; then
              echo "### âœ… Mobile Apps"
              echo "- Android and iOS builds completed"
              echo "- Version: Automatic build #${{ github.run_number }}"
              echo "- Artifacts available for download"
            elif [ "${{ needs.build-apps.result }}" == "skipped" ]; then
              echo "### â­ï¸ Mobile Apps"
              echo "- No Flutter changes detected, skipped"
            else
              echo "### âš ï¸ Mobile Apps"
              echo "- Some builds may have failed"
            fi

            echo ""
            echo "---"
            echo ""
            echo "### ðŸ“¦ Changed Files"
            echo '```'
            echo "${{ join(github.event.head_commit.modified, '\n') }}"
            echo '```'
            echo ""
            echo "### ðŸ”„ Next Steps"
            echo "1. Check build artifacts if apps were built"
            echo "2. Download and test before submitting to app stores"
            echo "3. Use manual workflows for production releases with version tags"
          } >> "$GITHUB_STEP_SUMMARY"