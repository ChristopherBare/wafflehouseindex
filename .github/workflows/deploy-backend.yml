name: Deploy Backend Infrastructure

on:
  # Automatic deployment on push to master
  push:
    branches:
      - master
    paths:
      - 'terraform/**'
      - 'lambda/**'
      - '.github/workflows/deploy-backend.yml'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  terraform:
    name: Deploy Backend Infrastructure
    runs-on: ubuntu-latest

    outputs:
      api_gateway_url: ${{ steps.terraform-output.outputs.api_gateway_url }}
      cloudfront_url: ${{ steps.terraform-output.outputs.cloudfront_url }}
      lambda_function_name: ${{ steps.terraform-output.outputs.lambda_function_name }}
      dynamodb_table_name: ${{ steps.terraform-output.outputs.dynamodb_table_name }}
      cloudfront_distribution_id: ${{ steps.terraform-output.outputs.cloudfront_distribution_id }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Package Lambda Function
        run: |
          echo "ðŸ“¦ Packaging Lambda function..."
          cd lambda
          chmod +x package.sh
          ./package.sh

          # Verify package exists
          if [ ! -f "whi_handler.zip" ]; then
            echo "âŒ Lambda package not created"
            exit 1
          fi

          echo "âœ… Lambda package created successfully"
          ls -lh whi_handler.zip

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # Create state bucket and lock table if they don't exist
      - name: Setup Terraform Backend
        run: |
          echo "ðŸ”§ Setting up Terraform backend..."

          # Create state bucket if it doesn't exist
          aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null || {
            echo "Creating S3 state bucket..."
            aws s3api create-bucket \
              --bucket whi-terraform-state \
              --region us-east-1

            # Enable versioning
            aws s3api put-bucket-versioning \
              --bucket whi-terraform-state \
              --versioning-configuration Status=Enabled

            # Enable encryption
            aws s3api put-bucket-encryption \
              --bucket whi-terraform-state \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }]
              }'
          }

          # Create DynamoDB lock table if it doesn't exist
          aws dynamodb describe-table --table-name whi-terraform-lock 2>/dev/null || {
            echo "Creating DynamoDB lock table..."
            aws dynamodb create-table \
              --table-name whi-terraform-lock \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region us-east-1

            # Wait for table to be active
            aws dynamodb wait table-exists --table-name whi-terraform-lock --region us-east-1
          }

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -input=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan
        if: (github.event_name == 'push') || (github.event.inputs.terraform_action == 'plan' || github.event.inputs.terraform_action == 'apply')
        run: |
          cd terraform
          terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        if: (github.event_name == 'push') || (github.event.inputs.terraform_action == 'apply')
        run: |
          cd terraform
          terraform apply -auto-approve -input=false tfplan

      - name: Terraform Destroy
        if: github.event.inputs.terraform_action == 'destroy'
        run: |
          cd terraform
          echo "âš ï¸ Destroying infrastructure..."
          terraform destroy -auto-approve -input=false

      - name: Get Terraform Outputs
        if: (github.event_name == 'push') || (github.event.inputs.terraform_action == 'apply')
        id: terraform-output
        run: |
          cd terraform

          # Get outputs
          API_GATEWAY_URL=$(terraform output -raw api_gateway_url)
          CLOUDFRONT_URL=$(terraform output -raw cloudfront_url)
          LAMBDA_FUNCTION=$(terraform output -raw lambda_function_name)
          DYNAMODB_TABLE=$(terraform output -raw dynamodb_table_name)
          CLOUDFRONT_ID=$(terraform output -raw cloudfront_distribution_id)

          # Set outputs for other jobs
          echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "lambda_function_name=$LAMBDA_FUNCTION" >> $GITHUB_OUTPUT
          echo "dynamodb_table_name=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT

          # Display outputs
          echo "ðŸ“ API Endpoints:"
          echo "CloudFront URL: $CLOUDFRONT_URL"
          echo "API Gateway URL: $API_GATEWAY_URL"
          echo ""
          echo "ðŸ“Š Resources:"
          echo "Lambda Function: $LAMBDA_FUNCTION"
          echo "DynamoDB Table: $DYNAMODB_TABLE"
          echo "CloudFront Distribution: $CLOUDFRONT_ID"

      - name: Test API Endpoints
        if: (github.event_name == 'push') || (github.event.inputs.terraform_action == 'apply')
        run: |
          CLOUDFRONT_URL="${{ steps.terraform-output.outputs.cloudfront_url }}"

          echo "ðŸ§ª Testing API endpoints..."

          # Test health endpoint
          echo "Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -s "$CLOUDFRONT_URL/api/health")
          if echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            echo "Response: $HEALTH_RESPONSE"
            exit 1
          fi

          # Test coordinates endpoint (Atlanta)
          echo "Testing coordinates endpoint..."
          COORDS_RESPONSE=$(curl -s "$CLOUDFRONT_URL/api/index/coordinates/?lat=33.7490&lon=-84.3880&radius=50")
          TOTAL=$(echo "$COORDS_RESPONSE" | grep -o '"total":[0-9]*' | grep -o '[0-9]*' || echo "0")

          if [ "$TOTAL" -gt 0 ]; then
            echo "âœ… Coordinates endpoint working (found $TOTAL stores)"
          else
            echo "âš ï¸ Coordinates endpoint returned no stores (might be a data issue)"
          fi

      - name: Update Summary
        if: (github.event_name == 'push') || (github.event.inputs.terraform_action == 'apply')
        run: |
          {
            echo "## ðŸš€ Backend Deployment Complete"
            echo ""
            echo "### ðŸ“ API Endpoints"
            echo "- **CloudFront URL (Recommended):** ${{ steps.terraform-output.outputs.cloudfront_url }}"
            echo "- **API Gateway URL:** ${{ steps.terraform-output.outputs.api_gateway_url }}"
            echo ""
            echo "### ðŸ“Š AWS Resources"
            echo "- **Lambda Function:** \`${{ steps.terraform-output.outputs.lambda_function_name }}\`"
            echo "- **DynamoDB Table:** \`${{ steps.terraform-output.outputs.dynamodb_table_name }}\`"
            echo "- **CloudFront Distribution:** \`${{ steps.terraform-output.outputs.cloudfront_distribution_id }}\`"
            echo ""
            echo "### ðŸ” Example Usage"
            echo '```bash'
            echo 'curl "${{ steps.terraform-output.outputs.cloudfront_url }}/api/index/coordinates/?lat=33.7490&lon=-84.3880&radius=50"'
            echo '```'
            echo ""
            echo "### ðŸ“± Flutter App Configuration"
            echo "Update \`whi_flutter/lib/config.dart\`:"
            echo '```dart'
            echo 'static const bool useProduction = true;'
            echo 'static const String cloudfrontUrl = "${{ steps.terraform-output.outputs.cloudfront_url }}";'
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"