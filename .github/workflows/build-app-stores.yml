name: Build App Store Bundles

on:
  # Automatic builds on push to master or version tags
  push:
    branches:
      - master
    paths:
      - 'whi_flutter/**'
      - '.github/workflows/build-app-stores.yml'
    tags:
      - 'v*'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android App Bundle (AAB)'
        required: true
        type: boolean
        default: true
      build_ios:
        description: 'Build iOS App (IPA)'
        required: true
        type: boolean
        default: true
      build_mode:
        description: 'Build mode'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      build_number:
        description: 'Build number (e.g., 1)'
        required: true
        default: '1'
      cloudfront_url:
        description: 'CloudFront API URL (leave empty for local)'
        required: false
        type: string

jobs:
  resolve-backend-url:
    name: Resolve Backend URL
    runs-on: ubuntu-latest
    outputs:
      cloudfront_url: ${{ steps.resolve-url.outputs.cloudfront_url }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.cloudfront_url == ''
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.cloudfront_url == ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Resolve CloudFront URL
        id: resolve-url
        run: |
          CLOUDFRONT_URL="${{ github.event.inputs.cloudfront_url }}"
          if [ -z "$CLOUDFRONT_URL" ]; then
            if aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null; then
              cd terraform
              terraform init -input=false 2>/dev/null || true
              CLOUDFRONT_URL=$(terraform output -raw cloudfront_url 2>/dev/null || true)
            fi
          fi

          echo "cloudfront_url=$CLOUDFRONT_URL" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android App Bundle
    needs: [resolve-backend-url]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_android == 'true'
    outputs:
      build_mode: ${{ steps.determine-mode.outputs.build_mode }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Determine Build Mode
        id: determine-mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_MODE="${{ github.event.inputs.build_mode || 'debug' }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            BUILD_MODE="release"
          else
            BUILD_MODE="debug"
          fi
          echo "build_mode=$BUILD_MODE" >> "$GITHUB_OUTPUT"

      - name: Resolve Version and Build Number
        id: version
        run: |
          cd whi_flutter

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use provided values or auto-increment
            if [ ! -z "${{ github.event.inputs.version_name }}" ]; then
              VERSION="${{ github.event.inputs.version_name }}"
              BUILD="${{ github.event.inputs.build_number }}"
            else
              # Auto-increment based on commits
              eval "$(./scripts/get-version.sh)"
              VERSION="$version_name"
              BUILD="$build_number"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag-based release - extract version from tag
            REF_NAME="${{ github.ref_name }}"
            VERSION="${REF_NAME#v}"
            BUILD="1"
          else
            # Regular push to master - auto-increment build number
            eval "$(./scripts/get-version.sh)"
            VERSION="$version_name"
            BUILD="$build_number"
          fi

          echo "version_name=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD" >> "$GITHUB_OUTPUT"
          echo "âœ… Resolved version to $VERSION+$BUILD"

      - name: Update API Configuration
        if: needs.resolve-backend-url.outputs.cloudfront_url != ''
        run: |
          cd whi_flutter

          # Update config.dart with production URL
          cat > lib/config.dart << 'EOF'
          /// API Configuration for Waffle House Index
          ///
          /// Auto-generated by GitHub Actions
          class ApiConfig {
            // Production configuration
            static const bool useProduction = true;

            // Set to true to enable premium features for local testing
            static const bool testPremiumEnabled = false;

            // CloudFront URL from GitHub Actions
            static const String cloudfrontUrl = "${{ needs.resolve-backend-url.outputs.cloudfront_url }}";

            // Local development URLs
            static const String localUrlAndroid = "http://10.0.2.2:8000";
            static const String localUrlDesktop = "http://localhost:8000";
            static const String localUrlIOS = "http://localhost:8000";

            // In-app purchase product IDs
            static const String premiumMonthlyProductId = "whi_premium_monthly";
            static const String premiumAnnualProductId = "whi_premium_annual";
            static const Set<String> premiumProductIds = {
              premiumMonthlyProductId,
              premiumAnnualProductId,
            };

            /// Get the appropriate API base URL based on platform and environment
            static String getApiBaseUrl({required bool isAndroid, required bool isIOS, required bool isDesktop}) {
              if (useProduction) {
                return cloudfrontUrl;
              }

              if (isAndroid) {
                return localUrlAndroid;
              } else if (isIOS) {
                return localUrlIOS;
              } else {
                return localUrlDesktop;
              }
            }
          }
          EOF

          echo "âœ… Updated API configuration with CloudFront URL"

      - name: Get Flutter Dependencies
        run: |
          cd whi_flutter
          flutter pub get

      - name: Clean Flutter Build Cache
        run: |
          cd whi_flutter
          flutter clean

      - name: Set Version and Build Number
        run: |
          cd whi_flutter

          # Update pubspec.yaml with version and build number
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml

          echo "âœ… Set version to ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}"

      # Create keystore for signing (you'll need to add these secrets)
      - name: Setup Android Signing
        if: steps.determine-mode.outputs.build_mode == 'release'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
        run: |
          cd whi_flutter/android

          # Decode keystore from base64 secret
          if [ ! -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/upload-keystore.jks
            echo "âœ… Keystore created"
          else
            echo "âš ï¸ No keystore found in secrets, using debug signing"
          fi

          # Create key.properties file
          if [ ! -z "$ANDROID_KEY_PROPERTIES" ]; then
            echo "$ANDROID_KEY_PROPERTIES" > key.properties
            echo "âœ… key.properties created"
          else
            echo "âš ï¸ No key.properties found, creating default"
            cat > key.properties << EOF
          storePassword=android
          keyPassword=android
          keyAlias=androiddebugkey
          storeFile=upload-keystore.jks
          EOF
          fi

      - name: Build Android App Bundle
        run: |
          cd whi_flutter
          BUILD_MODE="${{ steps.determine-mode.outputs.build_mode }}"

          if [ "$BUILD_MODE" == "release" ]; then
            echo "ğŸ”¨ Building Android App Bundle (Release)..."
            flutter build appbundle --release --build-name=${{ steps.version.outputs.version_name }} --build-number=${{ steps.version.outputs.build_number }}
          else
            echo "ğŸ”¨ Building Android App Bundle (Debug)..."
            flutter build appbundle --debug --build-name=${{ steps.version.outputs.version_name }} --build-number=${{ steps.version.outputs.build_number }}
          fi

          # Verify the bundle was created
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ] || [ -f "build/app/outputs/bundle/debug/app-debug.aab" ]; then
            echo "âœ… Android App Bundle created successfully"
            ls -lh build/app/outputs/bundle/*/
          else
            echo "âŒ Failed to create Android App Bundle"
            exit 1
          fi

      - name: Upload Android App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-app-bundle-${{ github.event.inputs.build_mode || 'debug' }}
          path: |
            whi_flutter/build/app/outputs/bundle/*/app-*.aab
          retention-days: 30

      - name: Generate Android Summary
        run: |
          {
            echo "## ğŸ¤– Android Build Complete"
            echo ""
            echo "### ğŸ“¦ Build Details"
            echo "- **Version:** ${{ steps.version.outputs.version_name }}"
            echo "- **Build Number:** ${{ steps.version.outputs.build_number }}"
            echo "- **Build Mode:** ${{ github.event.inputs.build_mode }}"
            echo ""
            if [ "${{ github.event.inputs.build_mode }}" == "release" ]; then
              echo "### ğŸ“± Google Play Console Upload"
              echo "1. Download the AAB artifact from this workflow"
              echo "2. Go to [Google Play Console](https://play.google.com/console)"
              echo "3. Select your app"
              echo "4. Navigate to **Release > Production**"
              echo "5. Create a new release and upload the AAB file"
              echo ""
              echo "### âš ï¸ Important"
              echo "- Ensure the signing key matches the one registered with Google Play"
              echo "- Test on internal testing track first before production release"
            else
              echo "### ğŸ§ª Debug Build"
              echo "This is a debug build and cannot be uploaded to Google Play."
              echo "Use for testing purposes only."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: [resolve-backend-url]
    if: github.event_name == 'push' || github.event.inputs.build_ios == 'true'
    outputs:
      build_mode: ${{ steps.determine-mode.outputs.build_mode }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Determine Build Mode
        id: determine-mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_MODE="${{ github.event.inputs.build_mode || 'debug' }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            BUILD_MODE="release"
          else
            BUILD_MODE="debug"
          fi
          echo "build_mode=$BUILD_MODE" >> "$GITHUB_OUTPUT"

      - name: Resolve Version and Build Number
        id: version
        run: |
          cd whi_flutter

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use provided values or auto-increment
            if [ ! -z "${{ github.event.inputs.version_name }}" ]; then
              VERSION="${{ github.event.inputs.version_name }}"
              BUILD="${{ github.event.inputs.build_number }}"
            else
              # Auto-increment based on commits
              eval "$(./scripts/get-version.sh)"
              VERSION="$version_name"
              BUILD="$build_number"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag-based release - extract version from tag
            REF_NAME="${{ github.ref_name }}"
            VERSION="${REF_NAME#v}"
            BUILD="1"
          else
            # Regular push to master - auto-increment build number
            eval "$(./scripts/get-version.sh)"
            VERSION="$version_name"
            BUILD="$build_number"
          fi

          echo "version_name=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD" >> "$GITHUB_OUTPUT"
          echo "âœ… Resolved version to $VERSION+$BUILD"

      - name: Update API Configuration
        if: needs.resolve-backend-url.outputs.cloudfront_url != ''
        run: |
          cd whi_flutter

          # Update config.dart with production URL
          cat > lib/config.dart << 'EOF'
          /// API Configuration for Waffle House Index
          ///
          /// Auto-generated by GitHub Actions
          class ApiConfig {
            // Production configuration
            static const bool useProduction = true;

            // Set to true to enable premium features for local testing
            static const bool testPremiumEnabled = false;

            // CloudFront URL from GitHub Actions
            static const String cloudfrontUrl = "${{ needs.resolve-backend-url.outputs.cloudfront_url }}";

            // Local development URLs
            static const String localUrlAndroid = "http://10.0.2.2:8000";
            static const String localUrlDesktop = "http://localhost:8000";
            static const String localUrlIOS = "http://localhost:8000";

            // In-app purchase product IDs
            static const String premiumMonthlyProductId = "whi_premium_monthly";
            static const String premiumAnnualProductId = "whi_premium_annual";
            static const Set<String> premiumProductIds = {
              premiumMonthlyProductId,
              premiumAnnualProductId,
            };

            /// Get the appropriate API base URL based on platform and environment
            static String getApiBaseUrl({required bool isAndroid, required bool isIOS, required bool isDesktop}) {
              if (useProduction) {
                return cloudfrontUrl;
              }

              if (isAndroid) {
                return localUrlAndroid;
              } else if (isIOS) {
                return localUrlIOS;
              } else {
                return localUrlDesktop;
              }
            }
          }
          EOF

          echo "âœ… Updated API configuration with CloudFront URL"

      - name: Get Flutter Dependencies
        run: |
          cd whi_flutter
          flutter pub get

      - name: Clean Flutter Build Cache
        run: |
          cd whi_flutter
          flutter clean

      - name: Set Version and Build Number
        run: |
          cd whi_flutter

          # Update pubspec.yaml with version and build number
          sed -i '' "s/^version:.*/version: ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml

          echo "âœ… Set version to ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}"

      # Install Apple certificates and provisioning profiles
      - name: Install Apple Certificate
        if: steps.determine-mode.outputs.build_mode == 'release'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
            echo "âš ï¸ No iOS signing certificate found in secrets"
            echo "Building without code signing (will create .app instead of .ipa)"
          else
            # Create variables
            CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
            PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
            KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

            # Import certificate and provisioning profile
            echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
            echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

            # Create temporary keychain
            security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

            # Import certificate to keychain
            security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH

            # Apply provisioning profile
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

            echo "âœ… iOS signing configured"
          fi

      - name: Build iOS App
        run: |
          cd whi_flutter
          BUILD_MODE="${{ steps.determine-mode.outputs.build_mode }}"

          if [ "$BUILD_MODE" == "release" ]; then
            echo "ğŸ”¨ Building iOS App (Release)..."
            flutter build ios --release --no-codesign --build-name=${{ steps.version.outputs.version_name }} --build-number=${{ steps.version.outputs.build_number }}

            # Create IPA if signing is configured
            if [ ! -z "${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}" ]; then
              echo "ğŸ“¦ Creating IPA..."
              cd ios
              xcodebuild -workspace Runner.xcworkspace \
                -scheme Runner \
                -configuration Release \
                -archivePath build/Runner.xcarchive \
                archive

              xcodebuild -exportArchive \
                -archivePath build/Runner.xcarchive \
                -exportPath build/ipa \
                -exportOptionsPlist ExportOptions.plist

              echo "âœ… IPA created successfully"
            else
              echo "âš ï¸ Skipping IPA creation (no signing certificate)"
            fi
          else
            echo "ğŸ”¨ Building iOS App (Debug Simulator)..."
            flutter build ios --debug --simulator --build-name=${{ steps.version.outputs.version_name }} --build-number=${{ steps.version.outputs.build_number }}
          fi

      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ steps.determine-mode.outputs.build_mode }}
          path: |
            whi_flutter/build/ios/
            whi_flutter/ios/build/
          if-no-files-found: error
          retention-days: 30

      - name: Generate iOS Summary
        run: |
          {
            echo "## ğŸ iOS Build Complete"
            echo ""
            echo "### ğŸ“¦ Build Details"
            echo "- **Version:** ${{ steps.version.outputs.version_name }}"
            echo "- **Build Number:** ${{ steps.version.outputs.build_number }}"
            echo "- **Build Mode:** ${{ github.event.inputs.build_mode }}"
            echo ""
            if [ "${{ github.event.inputs.build_mode }}" == "release" ]; then
              echo "### ğŸ“± App Store Connect Upload"
              echo "1. Download the iOS build artifact from this workflow"
              if [ ! -z "${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}" ]; then
                echo "2. Use **Transporter** app or **Xcode** to upload the IPA"
                echo "3. Go to [App Store Connect](https://appstoreconnect.apple.com)"
                echo "4. Select your app"
                echo "5. Navigate to **TestFlight** or **App Store** tab"
                echo "6. Submit for review"
              else
                echo "2. âš ï¸ **Note:** No IPA was created (missing signing certificate)"
                echo "3. You'll need to sign the app locally with Xcode"
                echo "4. Open the project in Xcode and archive it manually"
              fi
              echo ""
              echo "### âš ï¸ Important"
              echo "- Ensure Info.plist is configured correctly"
              echo "- Add required app permissions descriptions"
              echo "- Test on TestFlight before production release"
            else
              echo "### ğŸ§ª Debug Build"
              echo "This is a debug build for simulator testing only."
              echo "Cannot be uploaded to App Store Connect."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  build-linux:
    name: Build Linux App Bundle
    runs-on: ubuntu-latest
    needs: [resolve-backend-url]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake git ninja-build pkg-config libgtk-3-dev \
            libblkid-dev liblzma-dev libssl-dev

      - name: Resolve Version and Build Number
        id: version
        run: |
          cd whi_flutter

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use provided values or auto-increment
            if [ ! -z "${{ github.event.inputs.version_name }}" ]; then
              VERSION="${{ github.event.inputs.version_name }}"
              BUILD="${{ github.event.inputs.build_number }}"
            else
              # Auto-increment based on commits
              eval "$(./scripts/get-version.sh)"
              VERSION="$version_name"
              BUILD="$build_number"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag-based release - extract version from tag
            REF_NAME="${{ github.ref_name }}"
            VERSION="${REF_NAME#v}"
            BUILD="1"
          else
            # Regular push to master - auto-increment build number
            eval "$(./scripts/get-version.sh)"
            VERSION="$version_name"
            BUILD="$build_number"
          fi

          echo "version_name=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD" >> "$GITHUB_OUTPUT"
          echo "âœ… Resolved version to $VERSION+$BUILD"

      - name: Update API Configuration
        if: needs.resolve-backend-url.outputs.cloudfront_url != ''
        run: |
          cd whi_flutter

          # Update config.dart with production URL
          cat > lib/config.dart << 'EOF'
          /// API Configuration for Waffle House Index
          ///
          /// Auto-generated by GitHub Actions
          class ApiConfig {
            // Production configuration
            static const bool useProduction = true;

            // Set to true to enable premium features for local testing
            static const bool testPremiumEnabled = false;

            // CloudFront URL from GitHub Actions
            static const String cloudfrontUrl = "${{ needs.resolve-backend-url.outputs.cloudfront_url }}";

            // Local development URLs
            static const String localUrlAndroid = "http://10.0.2.2:8000";
            static const String localUrlDesktop = "http://localhost:8000";
            static const String localUrlIOS = "http://localhost:8000";

            // In-app purchase product IDs
            static const String premiumMonthlyProductId = "whi_premium_monthly";
            static const String premiumAnnualProductId = "whi_premium_annual";
            static const Set<String> premiumProductIds = {
              premiumMonthlyProductId,
              premiumAnnualProductId,
            };

            /// Get the appropriate API base URL based on platform and environment
            static String getApiBaseUrl({required bool isAndroid, required bool isIOS, required bool isDesktop}) {
              if (useProduction) {
                return cloudfrontUrl;
              }

              if (isAndroid) {
                return localUrlAndroid;
              } else if (isIOS) {
                return localUrlIOS;
              } else {
                return localUrlDesktop;
              }
            }
          }
          EOF

          echo "âœ… Updated API configuration with CloudFront URL"

      - name: Get Flutter Dependencies
        run: |
          cd whi_flutter
          flutter pub get

      - name: Clean Flutter Build Cache
        run: |
          cd whi_flutter
          flutter clean

      - name: Regenerate Flutter Platform Files
        run: |
          cd whi_flutter
          flutter pub get
          flutter create . --platforms=linux

      - name: Setup Flutter Linux Engine
        run: |
          cd whi_flutter

          # Get Flutter SDK path
          FLUTTER_SDK=$(which flutter | xargs dirname | xargs dirname)
          ENGINE_PATH="$FLUTTER_SDK/bin/cache/artifacts/engine/linux-x64"
          EPHEMERAL_DIR="linux/flutter/ephemeral"

          # Copy engine binaries and data files
          cp "$ENGINE_PATH/libflutter_linux_gtk.so" "$EPHEMERAL_DIR/" 2>/dev/null || true
          cp "$ENGINE_PATH/icudtl.dat" "$EPHEMERAL_DIR/" 2>/dev/null || true
          cp "$ENGINE_PATH/libpath_ops.so" "$EPHEMERAL_DIR/" 2>/dev/null || true
          cp "$ENGINE_PATH/libtessellator.so" "$EPHEMERAL_DIR/" 2>/dev/null || true

          # Copy headers if release version doesn't have them
          if [ ! -d "$EPHEMERAL_DIR/flutter_linux" ]; then
            if [ -d "$FLUTTER_SDK/bin/cache/artifacts/engine/linux-x64-release/flutter_linux" ]; then
              cp -r "$FLUTTER_SDK/bin/cache/artifacts/engine/linux-x64-release/flutter_linux" "$EPHEMERAL_DIR/"
            elif [ -d "$FLUTTER_SDK/bin/cache/artifacts/engine/linux-x64/flutter_linux" ]; then
              cp -r "$FLUTTER_SDK/bin/cache/artifacts/engine/linux-x64/flutter_linux" "$EPHEMERAL_DIR/"
            fi
          fi

          echo "âœ… Flutter Linux engine setup complete"

      - name: Set Version and Build Number
        run: |
          cd whi_flutter

          # Update pubspec.yaml with version and build number
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml

          echo "âœ… Set version to ${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}"

      - name: Build Linux App Bundle
        run: |
          cd whi_flutter

          echo "ğŸ”¨ Building Linux App Bundle..."
          flutter build linux --release

          # Create a relocatable app bundle
          BUNDLE_DIR="build/linux_bundle/whi-${{ steps.version.outputs.version_name }}"
          mkdir -p "$BUNDLE_DIR"

          # Copy the release binary and dependencies
          cp -r build/linux/x64/release/bundle/* "$BUNDLE_DIR/"

          # Create a wrapper script for easier launching
          cat > "$BUNDLE_DIR/whi.sh" << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/whi_flutter" "$@"
          LAUNCHER

          chmod +x "$BUNDLE_DIR/whi.sh"

          # Create a tar.gz archive for distribution
          cd build/linux_bundle
          tar -czf "whi-linux-${{ steps.version.outputs.version_name }}.tar.gz" "whi-${{ steps.version.outputs.version_name }}"

          echo "âœ… Linux App Bundle created successfully"
          ls -lh "whi-linux-${{ steps.version.outputs.version_name }}.tar.gz"

      - name: Upload Linux App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: linux-app-bundle
          path: whi_flutter/build/linux_bundle/whi-linux-*.tar.gz
          retention-days: 30

      - name: Generate Linux Summary
        run: |
          {
            echo "## ğŸ§ Linux Build Complete"
            echo ""
            echo "### ğŸ“¦ Build Details"
            echo "- **Version:** ${{ steps.version.outputs.version_name }}"
            echo "- **Build Number:** ${{ steps.version.outputs.build_number }}"
            echo ""
            echo "### ğŸ“¥ Installation Instructions"
            echo "1. Download the Linux app bundle tarball from artifacts"
            echo "2. Extract: \`tar -xzf whi-linux-*.tar.gz\`"
            echo "3. Run: \`./whi-linux-*/whi.sh\` or \`./whi-linux-*/whi_flutter\`"
            echo ""
            echo "### â„¹ï¸ System Requirements"
            echo "- Linux (glibc-based distributions recommended)"
            echo "- GTK 3.0 or later"
            echo "- Required libraries are bundled in the app directory"
            echo ""
            echo "### âš ï¸ Notes"
            echo "- The bundle includes all necessary dependencies for Linux"
            echo "- Works on most Linux distributions with glibc"
            echo "- For custom builds, use \`flutter build linux --release\`"
          } >> "$GITHUB_STEP_SUMMARY"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-linux]
    if: always() && (needs.build-android.result == 'success' || needs.build-ios.result == 'success' || needs.build-linux.result == 'success')
    continue-on-error: true

    steps:
      - name: Download Android Artifact
        if: needs.build-android.result == 'success'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle-${{ needs.build-android.outputs.build_mode }}
          path: ./artifacts/android/

      - name: Download iOS Artifact
        if: needs.build-ios.result == 'success'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ios-app-${{ needs.build-ios.outputs.build_mode }}
          path: ./artifacts/ios/

      - name: Download Linux Artifact
        if: needs.build-linux.result == 'success'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: linux-app-bundle
          path: ./artifacts/linux/

      - name: Create Release Summary
        run: |
          {
            echo "# ğŸ“± Waffle House Index App - Build Complete"
            echo ""
            echo "## Version Information"
            echo "- **Version:** ${{ github.event.inputs.version_name }}"
            echo "- **Build Number:** ${{ github.event.inputs.build_number }}"
            echo "- **Build Mode:** ${{ github.event.inputs.build_mode }}"
            echo "- **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## ğŸ“¦ Build Artifacts"
            if [ "${{ needs.build-android.result }}" == "success" ]; then
              echo "### ğŸ¤– Android"
              echo "- âœ… Android App Bundle (.aab) built successfully"
              echo "- Ready for Google Play Console upload"
            fi
            echo ""
            if [ "${{ needs.build-ios.result }}" == "success" ]; then
              echo "### ğŸ iOS"
              echo "- âœ… iOS App built successfully"
              if [ ! -z "${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}" ]; then
                echo "- IPA ready for App Store Connect upload"
              else
                echo "- App bundle ready (requires local signing)"
              fi
            fi
            echo ""
            if [ "${{ needs.build-linux.result }}" == "success" ]; then
              echo "### ğŸ§ Linux"
              echo "- âœ… Linux App Bundle built successfully"
              echo "- Ready for distribution (works on any Linux system)"
            fi
            echo ""
            echo "## ğŸš€ Next Steps"
            echo ""
            echo "### For Android:"
            echo "1. Download the AAB artifact above"
            echo "2. Upload to [Google Play Console](https://play.google.com/console)"
            echo "3. Submit for review"
            echo ""
            echo "### For iOS:"
            echo "1. Download the iOS artifact above"
            echo "2. Upload to [App Store Connect](https://appstoreconnect.apple.com)"
            echo "3. Submit for review"
            echo ""
            echo "### For Linux:"
            echo "1. Download the Linux app bundle tarball above"
            echo "2. Extract: \`tar -xzf whi-linux-*.tar.gz\`"
            echo "3. Run: \`./whi-linux-*/whi.sh\` or \`./whi-linux-*/whi_flutter\`"
            echo "4. Bundle works on any Linux system with glibc"
            echo ""
            echo "---"
            echo "*Built with GitHub Actions* ğŸš€"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Debug: Check artifact contents
        run: |
          echo "ğŸ“‚ Artifact directory contents:"
          find artifacts -type f \( -name "*.aab" -o -name "*.tar.gz" \) | head -20
          echo ""
          echo "ğŸ“‚ Full artifacts structure:"
          ls -lh artifacts/ 2>/dev/null || echo "No artifacts directory"

      - name: Prepare Release Assets
        run: |
          mkdir -p release_assets

          # Copy Android AAB if it exists (look in both release and debug subdirs)
          if [ -f "artifacts/android/app-release.aab" ]; then
            cp artifacts/android/app-release.aab release_assets/
            echo "âœ… Android AAB found (release)"
          elif [ -f "artifacts/android/app-debug.aab" ]; then
            cp artifacts/android/app-debug.aab release_assets/
            echo "âœ… Android AAB found (debug)"
          elif find artifacts/android -name "*.aab" 2>/dev/null | head -1 | xargs -I {} cp {} release_assets/ 2>/dev/null; then
            echo "âœ… Android AAB found (searched)"
          else
            echo "âš ï¸ No Android AAB found in artifacts/android"
          fi

          # Copy Linux tarball if it exists
          if ls artifacts/linux/whi-linux-*.tar.gz 1> /dev/null 2>&1; then
            cp artifacts/linux/whi-linux-*.tar.gz release_assets/
            echo "âœ… Linux bundle found"
          else
            echo "âš ï¸ No Linux bundle found"
          fi

          # List what we're uploading
          echo ""
          echo "ğŸ“¦ Release assets to upload:"
          ls -lh release_assets/ || echo "No assets prepared"

      - name: Create GitHub Release
        if: success() && (github.ref_type == 'tag' || github.event_name == 'workflow_dispatch' || github.event_name == 'push')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || format('v{0}+{1}', github.event.inputs.version_name || github.run_number, github.run_attempt) }}
          name: ${{ github.ref_type == 'tag' && format('Release {0}', github.ref_name) || format('Build v{0}+{1}', github.event.inputs.version_name || github.run_number, github.run_attempt) }}
          draft: false
          prerelease: ${{ github.ref_type != 'tag' }}
          files: |
            release_assets/app-*.aab
            release_assets/whi-linux-*.tar.gz
          body: |
            # ğŸ“± Waffle House Index App Release

            **Version:** ${{ github.ref_type == 'tag' && github.ref_name || format('v{0}', github.event.inputs.version_name) }}
            **Build Number:** ${{ github.run_number }}
            **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

            ## ğŸ“¦ Build Artifacts

            - ğŸ¤– **Android**: Android App Bundle (.aab)
            - ğŸ§ **Linux**: Linux App Bundle (tarball)

            Ready for app store submission!
