name: Full Deployment Pipeline

on:
  # Manual trigger only (won't run automatically)
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend infrastructure'
        required: true
        type: boolean
        default: true
      build_apps:
        description: 'Build mobile apps'
        required: true
        type: boolean
        default: true
      version_name:
        description: 'App version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      build_number:
        description: 'Build number'
        required: true
        default: '1'

  # Uncomment for automatic deployment on tags
  # push:
  #   tags:
  #     - 'release-*'

jobs:
  deploy-backend:
    name: Deploy Backend Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_backend == 'true'
    outputs:
      cloudfront_url: ${{ steps.get-url.outputs.cloudfront_url }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Package Lambda Function
        run: |
          cd lambda
          chmod +x package.sh
          ./package.sh

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy Infrastructure
        run: |
          cd terraform

          # Ensure backend exists
          aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null || {
            aws s3api create-bucket --bucket whi-terraform-state --region us-east-1
            aws s3api put-bucket-versioning --bucket whi-terraform-state --versioning-configuration Status=Enabled
          }

          aws dynamodb describe-table --table-name whi-terraform-lock 2>/dev/null || {
            aws dynamodb create-table \
              --table-name whi-terraform-lock \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region us-east-1
            aws dynamodb wait table-exists --table-name whi-terraform-lock --region us-east-1
          }

          # Deploy
          terraform init -input=false
          terraform apply -auto-approve -input=false

      - name: Get CloudFront URL
        id: get-url
        run: |
          cd terraform
          CLOUDFRONT_URL=$(terraform output -raw cloudfront_url)
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "CloudFront URL: $CLOUDFRONT_URL"

  get-backend-url:
    name: Get Existing Backend URL
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: needs.deploy-backend.result == 'skipped'
    outputs:
      cloudfront_url: ${{ steps.get-url.outputs.cloudfront_url }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get CloudFront URL
        id: get-url
        run: |
          CLOUDFRONT_URL=""
          if aws s3api head-bucket --bucket whi-terraform-state 2>/dev/null; then
            cd terraform
            terraform init -input=false 2>/dev/null || true
            CLOUDFRONT_URL=$(terraform output -raw cloudfront_url 2>/dev/null || true)
          fi

          echo "cloudfront_url=$CLOUDFRONT_URL" >> "$GITHUB_OUTPUT"

  build-apps:
    name: Build Mobile Apps
    needs: [deploy-backend, get-backend-url]
    if: |
      always() &&
      (github.event.inputs.build_apps == 'true' || needs.deploy-backend.result == 'skipped')
    strategy:
      matrix:
        platform: [android, ios]
        include:
          - platform: android
            os: ubuntu-latest
          - platform: ios
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Update API Configuration
        run: |
          cd whi_flutter

          # Use CloudFront URL from backend deployment or empty for local
          CLOUDFRONT_URL="${{ needs.deploy-backend.outputs.cloudfront_url }}"
          if [ -z "$CLOUDFRONT_URL" ]; then
            CLOUDFRONT_URL="${{ needs.get-backend-url.outputs.cloudfront_url }}"
          fi

          if [ ! -z "$CLOUDFRONT_URL" ]; then
            USE_PRODUCTION="true"
          else
            USE_PRODUCTION="false"
            CLOUDFRONT_URL="https://YOUR_DISTRIBUTION.cloudfront.net"
          fi

          cat > lib/config.dart << EOF
          /// API Configuration for Waffle House Index
          class ApiConfig {
            static const bool useProduction = $USE_PRODUCTION;
            static const String cloudfrontUrl = "$CLOUDFRONT_URL";
            static const String localUrlAndroid = "http://10.0.2.2:8000";
            static const String localUrlDesktop = "http://localhost:8000";
            static const String localUrlIOS = "http://localhost:8000";

            static String getApiBaseUrl({required bool isAndroid, required bool isIOS, required bool isDesktop}) {
              if (useProduction) {
                return cloudfrontUrl;
              }
              if (isAndroid) {
                return localUrlAndroid;
              } else if (isIOS) {
                return localUrlIOS;
              } else {
                return localUrlDesktop;
              }
            }
          }
          EOF

      - name: Get Flutter Dependencies
        run: |
          cd whi_flutter
          flutter pub get

      - name: Update Version
        run: |
          cd whi_flutter
          if [ "${{ matrix.platform }}" == "android" ]; then
            sed -i "s/^version:.*/version: ${{ github.event.inputs.version_name }}+${{ github.event.inputs.build_number }}/" pubspec.yaml
          else
            sed -i '' "s/^version:.*/version: ${{ github.event.inputs.version_name }}+${{ github.event.inputs.build_number }}/" pubspec.yaml
          fi

      # Android Build
      - name: Setup Android Signing
        if: matrix.platform == 'android'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
        run: |
          cd whi_flutter/android
          if [ ! -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/upload-keystore.jks
            echo "$ANDROID_KEY_PROPERTIES" > key.properties
          fi

      - name: Build Android App Bundle
        if: matrix.platform == 'android'
        run: |
          cd whi_flutter
          flutter build appbundle --release \
            --build-name=${{ github.event.inputs.version_name }} \
            --build-number=${{ github.event.inputs.build_number }}

      # iOS Build
      - name: Setup iOS Signing
        if: matrix.platform == 'ios'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          if [ ! -z "$BUILD_CERTIFICATE_BASE64" ]; then
            CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
            PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
            KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

            echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
            echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

            security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH

            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
          fi

      - name: Build iOS App
        if: matrix.platform == 'ios'
        run: |
          cd whi_flutter
          flutter build ios --release --no-codesign \
            --build-name=${{ github.event.inputs.version_name }} \
            --build-number=${{ github.event.inputs.build_number }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            whi_flutter/build/app/outputs/bundle/release/app-release.aab
            whi_flutter/build/ios/iphoneos/
          retention-days: 30

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, build-apps]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          {
            echo "# ðŸš€ Full Deployment Pipeline Complete"
            echo ""
            echo "## Version: ${{ github.event.inputs.version_name }} (Build ${{ github.event.inputs.build_number }})"
            echo ""

            if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
              echo "### âœ… Backend Infrastructure"
              echo "- CloudFront URL: ${{ needs.deploy-backend.outputs.cloudfront_url }}"
              echo ""
            elif [ "${{ needs.deploy-backend.result }}" == "skipped" ]; then
              echo "### â­ï¸ Backend Infrastructure"
              echo "- Deployment skipped"
              echo ""
            else
              echo "### âŒ Backend Infrastructure"
              echo "- Deployment failed"
              echo ""
            fi

            if [ "${{ needs.build-apps.result }}" == "success" ]; then
              echo "### âœ… Mobile Apps"
              echo "- Android AAB built successfully"
              echo "- iOS app built successfully"
              echo ""
              echo "#### Next Steps:"
              echo "1. Download build artifacts from this workflow"
              echo "2. Upload Android AAB to Google Play Console"
              echo "3. Upload iOS build to App Store Connect"
            elif [ "${{ needs.build-apps.result }}" == "skipped" ]; then
              echo "### â­ï¸ Mobile Apps"
              echo "- Build skipped"
            else
              echo "### âš ï¸ Mobile Apps"
              echo "- Some builds may have failed"
            fi

            echo ""
            echo "---"
            echo "*Workflow completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')*"
          } >> "$GITHUB_STEP_SUMMARY"
