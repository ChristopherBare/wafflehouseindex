Index: terraform/main.tf
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+># DynamoDB table for caching location data\nresource \"aws_dynamodb_table\" \"whi_locations_cache\" {\n  name           = \"whi-locations\"\n  billing_mode   = \"PAY_PER_REQUEST\"  # No fixed costs, pay only for what you use\n  hash_key       = \"id\"\n\n  attribute {\n    name = \"id\"\n    type = \"S\"\n  }\n\n  ttl {\n    attribute_name = \"ttl\"\n    enabled        = true\n  }\n\n  lifecycle {\n    create_before_destroy = false\n  }\n\n  tags = {\n    Name        = \"WHI Locations Cache\"\n    Environment = \"production\"\n    Project     = \"wafflehouseindex\"\n  }\n}\n\n# IAM role for Lambda\nresource \"aws_iam_role\" \"whi_lambda_role\" {\n  name = \"whi-lambda-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Action = \"sts:AssumeRole\"\n      Effect = \"Allow\"\n      Principal = {\n        Service = \"lambda.amazonaws.com\"\n      }\n    }]\n  })\n\n  lifecycle {\n    create_before_destroy = false\n  }\n}\n\n# IAM policy for Lambda\nresource \"aws_iam_policy\" \"whi_lambda_policy\" {\n  name = \"whi-lambda-policy\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"dynamodb:GetItem\",\n          \"dynamodb:PutItem\",\n          \"dynamodb:UpdateItem\",\n          \"dynamodb:Query\",\n          \"dynamodb:Scan\"\n        ]\n        Resource = aws_dynamodb_table.whi_locations_cache.arn\n      },\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"logs:CreateLogGroup\",\n          \"logs:CreateLogStream\",\n          \"logs:PutLogEvents\"\n        ]\n        Resource = \"arn:aws:logs:*:*:*\"\n      }\n    ]\n  })\n\n  lifecycle {\n    create_before_destroy = false\n  }\n}\n\n# Attach policy to role\nresource \"aws_iam_role_policy_attachment\" \"whi_lambda_policy_attachment\" {\n  role       = aws_iam_role.whi_lambda_role.name\n  policy_arn = aws_iam_policy.whi_lambda_policy.arn\n}\n\n# Lambda function\nresource \"aws_lambda_function\" \"whi_api\" {\n  filename         = \"../lambda/whi_handler.zip\"\n  function_name    = \"whi-api\"\n  role            = aws_iam_role.whi_lambda_role.arn\n  handler         = \"whi_handler.lambda_handler\"\n  source_code_hash = filebase64sha256(\"../lambda/whi_handler.zip\")\n  runtime         = \"python3.11\"\n  timeout         = 30  # Allow time for web scraping if cache miss\n  memory_size     = 256  # Enough for processing location data\n\n  environment {\n    variables = {\n      DYNAMODB_TABLE = aws_dynamodb_table.whi_locations_cache.name\n    }\n  }\n\n  tags = {\n    Name        = \"WHI API Lambda\"\n    Environment = \"production\"\n    Project     = \"wafflehouseindex\"\n  }\n}\n\n# API Gateway REST API\nresource \"aws_api_gateway_rest_api\" \"whi_api\" {\n  name        = \"whi-api\"\n  description = \"Waffle House Index API\"\n\n  endpoint_configuration {\n    types = [\"REGIONAL\"]  # Use REGIONAL for CloudFront\n  }\n}\n\n# API Gateway Resources\nresource \"aws_api_gateway_resource\" \"api\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  parent_id   = aws_api_gateway_rest_api.whi_api.root_resource_id\n  path_part   = \"api\"\n}\n\nresource \"aws_api_gateway_resource\" \"index\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  parent_id   = aws_api_gateway_resource.api.id\n  path_part   = \"index\"\n}\n\nresource \"aws_api_gateway_resource\" \"coordinates\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  parent_id   = aws_api_gateway_resource.index.id\n  path_part   = \"coordinates\"\n}\n\nresource \"aws_api_gateway_resource\" \"zip\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  parent_id   = aws_api_gateway_resource.index.id\n  path_part   = \"zip\"\n}\n\nresource \"aws_api_gateway_resource\" \"health\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  parent_id   = aws_api_gateway_resource.api.id\n  path_part   = \"health\"\n}\n\n# API Gateway Methods - Coordinates endpoint\nresource \"aws_api_gateway_method\" \"coordinates_get\" {\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  resource_id   = aws_api_gateway_resource.coordinates.id\n  http_method   = \"GET\"\n  authorization = \"NONE\"\n}\n\nresource \"aws_api_gateway_method\" \"coordinates_options\" {\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  resource_id   = aws_api_gateway_resource.coordinates.id\n  http_method   = \"OPTIONS\"\n  authorization = \"NONE\"\n}\n\n# API Gateway Methods - ZIP endpoint\nresource \"aws_api_gateway_method\" \"zip_get\" {\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  resource_id   = aws_api_gateway_resource.zip.id\n  http_method   = \"GET\"\n  authorization = \"NONE\"\n}\n\nresource \"aws_api_gateway_method\" \"zip_options\" {\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  resource_id   = aws_api_gateway_resource.zip.id\n  http_method   = \"OPTIONS\"\n  authorization = \"NONE\"\n}\n\n# API Gateway Methods - Health endpoint\nresource \"aws_api_gateway_method\" \"health_get\" {\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  resource_id   = aws_api_gateway_resource.health.id\n  http_method   = \"GET\"\n  authorization = \"NONE\"\n}\n\n# Lambda integrations\nresource \"aws_api_gateway_integration\" \"coordinates_get\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  resource_id = aws_api_gateway_resource.coordinates.id\n  http_method = aws_api_gateway_method.coordinates_get.http_method\n\n  integration_http_method = \"POST\"\n  type                   = \"AWS_PROXY\"\n  uri                    = aws_lambda_function.whi_api.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"coordinates_options\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  resource_id = aws_api_gateway_resource.coordinates.id\n  http_method = aws_api_gateway_method.coordinates_options.http_method\n\n  integration_http_method = \"POST\"\n  type                   = \"AWS_PROXY\"\n  uri                    = aws_lambda_function.whi_api.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"zip_get\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  resource_id = aws_api_gateway_resource.zip.id\n  http_method = aws_api_gateway_method.zip_get.http_method\n\n  integration_http_method = \"POST\"\n  type                   = \"AWS_PROXY\"\n  uri                    = aws_lambda_function.whi_api.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"zip_options\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  resource_id = aws_api_gateway_resource.zip.id\n  http_method = aws_api_gateway_method.zip_options.http_method\n\n  integration_http_method = \"POST\"\n  type                   = \"AWS_PROXY\"\n  uri                    = aws_lambda_function.whi_api.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"health_get\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n  resource_id = aws_api_gateway_resource.health.id\n  http_method = aws_api_gateway_method.health_get.http_method\n\n  integration_http_method = \"POST\"\n  type                   = \"AWS_PROXY\"\n  uri                    = aws_lambda_function.whi_api.invoke_arn\n}\n\n# Lambda permission for API Gateway\nresource \"aws_lambda_permission\" \"api_gateway\" {\n  statement_id  = \"AllowAPIGatewayInvoke\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.whi_api.function_name\n  principal     = \"apigateway.amazonaws.com\"\n  source_arn    = \"${aws_api_gateway_rest_api.whi_api.execution_arn}/*/*\"\n}\n\n# API Gateway Deployment\nresource \"aws_api_gateway_deployment\" \"whi_api\" {\n  rest_api_id = aws_api_gateway_rest_api.whi_api.id\n\n  depends_on = [\n    aws_api_gateway_integration.coordinates_get,\n    aws_api_gateway_integration.coordinates_options,\n    aws_api_gateway_integration.zip_get,\n    aws_api_gateway_integration.zip_options,\n    aws_api_gateway_integration.health_get,\n  ]\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\n# API Gateway Stage\nresource \"aws_api_gateway_stage\" \"prod\" {\n  deployment_id = aws_api_gateway_deployment.whi_api.id\n  rest_api_id   = aws_api_gateway_rest_api.whi_api.id\n  stage_name    = \"prod\"\n\n  # Enable caching for better performance\n  cache_cluster_enabled = false  # Set to true if you want API Gateway caching (costs extra)\n  cache_cluster_size    = \"0.5\"  # Smallest size if enabled\n\n  tags = {\n    Name        = \"WHI API Production\"\n    Environment = \"production\"\n    Project     = \"wafflehouseindex\"\n  }\n}\n\n# CloudFront distribution for caching and global performance\nresource \"aws_cloudfront_distribution\" \"whi_api\" {\n  enabled         = true\n  is_ipv6_enabled = true\n  comment         = \"WHI API CloudFront Distribution\"\n  price_class     = \"PriceClass_100\"  # Use only North America and Europe edge locations (cheaper)\n\n  origin {\n    domain_name = \"${aws_api_gateway_rest_api.whi_api.id}.execute-api.us-east-1.amazonaws.com\"\n    origin_id   = \"whi-api-gateway\"\n    origin_path = \"/prod\"\n\n    custom_origin_config {\n      http_port              = 80\n      https_port             = 443\n      origin_protocol_policy = \"https-only\"\n      origin_ssl_protocols   = [\"TLSv1.2\"]\n    }\n  }\n\n  default_cache_behavior {\n    allowed_methods  = [\"GET\", \"HEAD\", \"OPTIONS\"]\n    cached_methods   = [\"GET\", \"HEAD\", \"OPTIONS\"]\n    target_origin_id = \"whi-api-gateway\"\n\n    forwarded_values {\n      query_string = true  # Forward query strings for lat/lon/radius\n      headers      = [\"Origin\", \"Access-Control-Request-Headers\", \"Access-Control-Request-Method\"]\n\n      cookies {\n        forward = \"none\"\n      }\n    }\n\n    viewer_protocol_policy = \"redirect-to-https\"\n    min_ttl                = 0\n    default_ttl            = 300    # Cache for 5 minutes by default\n    max_ttl                = 3600   # Maximum 1 hour cache\n\n    compress = true\n  }\n\n  # Cache behavior for health endpoint (don't cache)\n  ordered_cache_behavior {\n    path_pattern     = \"/api/health\"\n    allowed_methods  = [\"GET\", \"HEAD\", \"OPTIONS\"]\n    cached_methods   = [\"GET\", \"HEAD\"]\n    target_origin_id = \"whi-api-gateway\"\n\n    forwarded_values {\n      query_string = false\n      cookies {\n        forward = \"none\"\n      }\n    }\n\n    viewer_protocol_policy = \"redirect-to-https\"\n    min_ttl                = 0\n    default_ttl            = 0\n    max_ttl                = 0\n  }\n\n  restrictions {\n    geo_restriction {\n      restriction_type = \"none\"\n    }\n  }\n\n  viewer_certificate {\n    cloudfront_default_certificate = true\n  }\n\n  tags = {\n    Name        = \"WHI API CloudFront\"\n    Environment = \"production\"\n    Project     = \"wafflehouseindex\"\n  }\n}\n\n# EventBridge rule for scheduled cache refresh (every 30 minutes)\nresource \"aws_cloudwatch_event_rule\" \"cache_refresh\" {\n  name                = \"whi-cache-refresh\"\n  description         = \"Refresh WHI location cache every 30 minutes\"\n  schedule_expression = \"rate(30 minutes)\"\n}\n\nresource \"aws_cloudwatch_event_target\" \"cache_refresh\" {\n  rule      = aws_cloudwatch_event_rule.cache_refresh.name\n  target_id = \"WHILambdaTarget\"\n  arn       = aws_lambda_function.whi_api.arn\n\n  input = jsonencode({\n    path       = \"/api/refresh\"\n    httpMethod = \"GET\"\n  })\n}\n\nresource \"aws_lambda_permission\" \"allow_eventbridge\" {\n  statement_id  = \"AllowExecutionFromEventBridge\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.whi_api.function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.cache_refresh.arn\n}
===================================================================
diff --git a/terraform/main.tf b/terraform/main.tf
--- a/terraform/main.tf	(revision 421c77096519f858d4cafd4d557b84db27e3d733)
+++ b/terraform/main.tf	(date 1769581268953)
@@ -15,7 +15,7 @@
   }
 
   lifecycle {
-    create_before_destroy = false
+    create_before_destroy = true
   }
 
   tags = {
